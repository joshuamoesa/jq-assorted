FROM 714079672139.dkr.ecr.eu-west-1.amazonaws.com/esb-bwce-build-ear:2.4.0 AS builder
WORKDIR /build

# For local build. Maybe its easier to use an http(s) based backend for local builds.
# ARG AWS_ACCESS_KEY_ID=x
# ARG AWS_SECRET_ACCESS_KEY=y
# ARG AWS_REGION=eu-west-1 

COPY tibco tibco
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN MAVEN_PLUGIN_VERSION="2.1.1" && \
    S3_ARTIFACT_STORE="s3://pnlbwce" && \
    EAR_VERSION="$(grep Bundle-Version tibco/esb-pes-var-dayoperatororder.application/META-INF/MANIFEST.MF | cut -d ':' -f 2 | cut -d '.' -f1,2,3 | xargs )" && \
    export MAVEN_PLUGIN_VERSION && \
    export S3_ARTIFACT_STORE && \
    export EAR_VERSION && \
    mvn deploy -B -Dbwce.version="${EAR_VERSION}" -Dmaven.plugin.version="${MAVEN_PLUGIN_VERSION}" -DskipTests=true -Dstore="${S3_ARTIFACT_STORE}" -f ./tibco/pom.xml -s /usr/share/maven/ref/settings-docker.xml

FROM 714079672139.dkr.ecr.eu-west-1.amazonaws.com/esb-bwcebase:2.5.4.4 as component
COPY --from=builder /tibco/esb-pes-var-dayoperatororder.application_*.ear /

 
EXPOSE 3306
ENV BW_PROFILE="Docker"
# 
# The local timezone is explicitly set here, this is so the Tibco engine uses this i.e. for current-date, current-time, translating timezones
# SBS uses data-times without timezone indication
ENV TZ=Europe/Amsterdam
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone#
# Start import content

ENV \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_MAXIMUMQTPTHREADS="75" \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_SPEC="v1" \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_PORT="8080" \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_BASEPATH="/var-processdayoperatororder/processdayoperatororder" \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_HOST="localhost" \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_MINIMUMQTPTHREADS="10" \
ESB_PES_VAR_DAYOPERATORORDER_CONNECTIONS_HTTP_REQREP_PROCESSDAYOPERATORORDER_HTTP_MONITORINGHTTPTIMEOUTMILLISECONDS="5000" \
ESB_PES_VAR_DAYOPERATORORDER_PROCESSES_HTTP_REQREP_PROCESSDAYOPERATORORDER_FUNCTIONALDOMAIN="PD" \
ESB_PES_VAR_DAYOPERATORORDER_PROCESSES_HTTP_REQREP_PROCESSDAYOPERATORORDER_LOGGINGOPERATION="processDayoperatororder"
ENV ESB_PES_VAR_DAYOPERATORORDER_PROCESSES_FTL_PUB_ESB_PROCESSDAYOPERATORORDER_FTLFORMATNAME="PDMessage"
ENV ESB_PES_VAR_DAYOPERATORORDER_PROCESSES_FTL_PUB_ESB_PROCESSDAYOPERATORORDER_FTLENDPOINT="EP_ESB_PD_Listen"
# End import content
ENV \
LOGGING_PROCESSES_DISPATCHLOG_SENDTOCENTRALCOMPONENT="true" \
LOGGING_PROCESSES_DISPATCHLOG_DEBUGINFORMATION="false" \
LOGGING_PROCESSES_DISPATCHLOG_LOGTOCONSOLE="true" \
LOGGING_PROCESSES_LOG_STACKTRACE_STRING_MAXLENGTH="5000" \
LOGGING_CONNECTIONS_FTL_USERNAME="anyone" \
LOGGING_CONNECTIONS_FTL_REALMSERVERBACKUPURL="http://localhost:8080" \
LOGGING_CONNECTIONS_FTL_REALMSERVERURL="http://localhost:8080" \
LOGGING_CONNECTIONS_FTL_PASSWORD="#!tSPcschfALbDIBS6Yj2LLg==" \
LOGGING_CONNECTIONS_FTL_APPNAME="logging" \
LOGGING_CONNECTIONS_FTL_APPINSTANCEID="" \
LOGGING_CONNECTIONS_FTL_REALMSERVERTRUSTFILE="" \
LOGGING_CONNECTIONS_FTL_CLIENTLABEL="esb-pes-var-dayoperatororder-log" \
LOGGING_CONNECTIONS_FTL_APPLICATIONNAME="Log" \
LOGGING_PROCESSES_ERRORREPORTVALUES_DEFAULTRECOVERABLECLASSVALUES="ActivityTimedOutException" \
LOGGING_PROCESSES_ERRORREPORTVALUES_DEFAULTRECOVERABLEMSGCODEVALUES="401,403,404,503,504,511,500009,500636,550170,555000,555010,555020,555030,TIBCO-BW-CORE-500050,TIBCO-BW-CORE-500636,TIBCO-BW-PALETTE-HTTP-500002,TIBCO-BW-PALETTE-HTTP-500013,TIBCO-BW-PALETTE-REST-2000027,TIBCO-BW-PALETTE-JDBC-500011,TIBCO-BW-PALETTE-SFTP-100001,TIBCO-BW-PALETTE-SFTP-100002,TIBCO-BW-PALETTE-SFTP-100004,TIBCO-BW-PALETTE-SFTP-100007,TIBCO-BW-PALETTE-SFTP-100010,TIBCO-BW-PALETTE-SFTP-100012,TIBCO-BW-PALETTE-SFTP-100013,TIBCO-BW-PALETTE-SFTP-100014,TIBCO-BW-PALETTE-SFTP-100017,TIBCO-BW-PALETTE-SFTP-100018,TIBCO-BW-PALETTE-SFTP-100021,TIBCO-BW-PALETTE-SFTP-100022,TIBCO-BW-PALETTE-SFTP-100034,TIBCO-BW-PALETTE-SFTP-100036,TIBCO-BW-PALETTE-SFTP-100037,TIBCO-BW-PALETTE-SFTP-100039,TIBCO-BW-PALETTE-SFTP-100050,TIBCO-BW-PALETTE-SFTP-100053,TIBCO-BW-PALETTE-SFTP-100054,TIBCO-BW-PALETTE-SFTP-100055,TIBCO-BW-PALETTE-SFTP-100058,TIBCO-BW-PALETTE-SFTP-100060,TIBCO-BW-PALETTE-SFTP-100062,TIBCO-BW-PALETTE-SFTP-100066" \
LOGGING_PROCESSES_ERRORREPORTVALUES_DEFAULTNONRECOVERABLECLASSVALUES="" \
LOGGING_PROCESSES_ERRORREPORTVALUES_DEFAULTNONRECOVERABLEMSGCODEVALUES="400,Mapping or Parsing error,Parsing or Mapping error,Parsing error,Mapping error,PVM-XML-106027" \
LOGGING_PROCESSES_ERRORREPORTVALUES_DEFAULTRECOVERABLEMSGVALUES="timed out,Connection timed out: connect,Connection refused: connect,[404] status code,Status Code: 429" \
LOGGING_PROCESSES_ERRORREPORTVALUES_DEFAULTNONRECOVERABLEMSGVALUES="[400] status code,Unable to parse the XML" \
LOGGING_PROCESSES_ERRORREPORTVALUES_IGNOREERRORMSGCODEVALUES="" \
LOGGING_PROCESSES_ERRORREPORTVALUES_IGNOREERRORMSGVALUES="" \
LOGGING_PROCESSES_ERRORREPORTVALUES_IGNOREERRORCLASSVALUES=""
ENV \
MESSAGEBROKER_CONNECTIONS_FTL_USERNAME="anyone" \
MESSAGEBROKER_CONNECTIONS_FTL_REALMSERVERBACKUPURL="http://localhost:8080" \
MESSAGEBROKER_CONNECTIONS_FTL_REALMSERVERURL="http://localhost:8080" \
MESSAGEBROKER_CONNECTIONS_FTL_PASSWORD="#!tSPcschfALbDIBS6Yj2LLg==" \
MESSAGEBROKER_CONNECTIONS_FTL_REALMSERVERTRUSTFILE="" \
MESSAGEBROKER_CONNECTIONS_FTL_CLIENTLABEL="esb-pes-var-dayoperatororder" \
MESSAGEBROKER_CONNECTIONS_FTL_APPNAME="PD" \
MESSAGEBROKER_CONNECTIONS_FTL_APPINSTANCEID=""

ENV \
MONITORING_CONNECTIONS_MONITORING_HTTP_PORT="7778" \
MONITORING_CONNECTIONS_MONITORING_HTTP_HOST="localhost" \
MONITORING_PROCESSES_MONITORING_CONNECTIVITY_CONNECTIONS="messagebroker"